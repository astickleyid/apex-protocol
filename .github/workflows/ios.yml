name: iOS starter workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Test default scheme using any available iPhone simulator
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
      - name: Install dependencies
        run: npm ci
      - name: Build web assets
        run: npm run build
      - name: Prepare Capacitor iOS assets
        run: |
          set -euo pipefail
          if [ ! -f capacitor.config.json ]; then
            echo "capacitor.config.json is missing."
            exit 1
          fi
          if [ ! -f package.json ]; then
            echo "package.json is missing."
            exit 1
          fi
          eval "$(node - <<'NODE'
          const fs = require('fs');
          const escape = (v) => String(v)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&apos;');
          const cfg = JSON.parse(fs.readFileSync('capacitor.config.json', 'utf8'));
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          if (!cfg.appId) throw new Error('appId missing');
          if (!cfg.appName) throw new Error('appName missing');
          if (!pkg.version) throw new Error('version missing');
          console.log(`APP_ID="${escape(cfg.appId)}"`);
          console.log(`APP_NAME="${escape(cfg.appName)}"`);
          console.log(`APP_VERSION="${escape(pkg.version)}"`);
          NODE
          )"
          mkdir -p ios/App/App
          cp capacitor.config.json ios/App/App/capacitor.config.json
          cat > ios/App/App/config.xml <<EOF
          <?xml version='1.0' encoding='utf-8'?>
          <widget id="${APP_ID}" version="${APP_VERSION}" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
            <name>${APP_NAME}</name>
            <content src="index.html" />
            <allow-navigation href="*" />
          </widget>
          EOF
          rm -rf ios/App/App/public
          if [ ! -d dist ]; then
            echo "dist directory not found; ensure npm run build produced output."
            exit 1
          fi
          if [ -z "$(ls -A dist)" ]; then
            echo "dist directory is empty; ensure the web build succeeded."
            exit 1
          fi
          cp -R dist ios/App/App/public
      - name: Set Default Scheme
        run: |
          scheme_list=$(xcodebuild -list -json | tr -d "\n")
          default=$(echo $scheme_list | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
          echo $default | cat >default
          echo Using default scheme: $default
      - name: Build
        env:
          scheme: ${{ 'default' }}
          platform: ${{ 'iOS Simulator' }}
        run: |
          # xcrun xctrace returns via stderr, not the expected stdout (see https://developer.apple.com/forums/thread/663959)
          device=`xcrun xctrace list devices 2>&1 | grep -oE 'iPhone.*?[^\(]+' | head -1 | awk '{$1=$1;print}' | sed -e "s/ Simulator$//"`
          if [ $scheme = default ]; then scheme=$(cat default); fi
          if [ "`ls -A | grep -i \\.xcworkspace\$`" ]; then filetype_parameter="workspace" && file_to_build="`ls -A | grep -i \\.xcworkspace\$`"; else filetype_parameter="project" && file_to_build="`ls -A | grep -i \\.xcodeproj\$`"; fi
          file_to_build=`echo $file_to_build | awk '{$1=$1;print}'`
          xcodebuild build-for-testing -scheme "$scheme" -"$filetype_parameter" "$file_to_build" -destination "platform=$platform,name=$device"
      - name: Test
        env:
          scheme: ${{ 'default' }}
          platform: ${{ 'iOS Simulator' }}
        run: |
          # xcrun xctrace returns via stderr, not the expected stdout (see https://developer.apple.com/forums/thread/663959)
          device=`xcrun xctrace list devices 2>&1 | grep -oE 'iPhone.*?[^\(]+' | head -1 | awk '{$1=$1;print}' | sed -e "s/ Simulator$//"`
          if [ $scheme = default ]; then scheme=$(cat default); fi
          if [ "`ls -A | grep -i \\.xcworkspace\$`" ]; then filetype_parameter="workspace" && file_to_build="`ls -A | grep -i \\.xcworkspace\$`"; else filetype_parameter="project" && file_to_build="`ls -A | grep -i \\.xcodeproj\$`"; fi
          file_to_build=`echo $file_to_build | awk '{$1=$1;print}'`
          xcodebuild test-without-building -scheme "$scheme" -"$filetype_parameter" "$file_to_build" -destination "platform=$platform,name=$device"
